x-oauth2-proxy-env: &oauth2-proxy-env
  <<: *domain-env
  OAUTH2_PROXY_REALM: ${OAUTH2_PROXY_REALM}
  OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET} # openssl rand -base64 32
  OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
  OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
  OAUTH2_PROXY_EMAIL_DOMAINS: ${OAUTH2_PROXY_EMAIL_DOMAINS}

x-oauth2-proxy-service: &oauth2-proxy-service
  <<: *service-base-with-proxy
  image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0
  container_name: oauth2-proxy
  environment:
    <<: *oauth2-proxy-env

    # Security
    OAUTH2_PROXY_CODE_CHALLENGE_METHOD: "S256"

    # OAuth2 Proxy settings
    OAUTH2_PROXY_PROVIDER: oidc
    OAUTH2_PROXY_OIDC_ISSUER_URL: "https://${KEYCLOAK_DOMAIN}/realms/${OAUTH2_PROXY_REALM}"
    OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
    OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"
    OAUTH2_PROXY_REDIRECT_URL: "https://${OAUTH2_PROXY_DOMAIN}/oauth2/callback"
    OAUTH2_PROXY_EXTRA_LOGIN_PARAMS: "prompt=select_account"
    OAUTH2_PROXY_BANNER: 'Если вы видите эту страницу, возможно, вы вошли не под рабочей почтой. <a href="https://auth.in-gr.ru/oauth2/sign_out">Выйти</a> и войти снова.'


    # Server settings
    OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
    OAUTH2_PROXY_REVERSE_PROXY: "true"

    # Scope and Headers settings
    OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
    OAUTH2_PROXY_PASS_USER_HEADERS: "true"
    OAUTH2_PROXY_SCOPE: "openid email profile groups"
    OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"

    # Cookie settings
    OAUTH2_PROXY_COOKIE_DOMAINS: ".${ROOT_DOMAIN}" 
    OAUTH2_PROXY_WHITELIST_DOMAINS: ".${ROOT_DOMAIN}"
    OAUTH2_PROXY_COOKIE_SECURE: "true"
    OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
    OAUTH2_PROXY_EMAIL_DOMAINS: "${OAUTH2_PROXY_EMAIL_DOMAINS}" 
    OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "false"

    # Logout
    OAUTH2_PROXY_SIGN_OUT_PATH: "/oauth2/sign_out"
    OAUTH2_PROXY_END_SESSION_URL: "https://${KEYCLOAK_DOMAIN}/realms/${OAUTH2_PROXY_REALM}/protocol/openid-connect/logout"
    OAUTH2_PROXY_POST_LOGOUT_REDIRECT_URL: "https://${TRAEFIK_DOMAIN}/"
    AUTH2_PROXY_COOKIE_REFRESH: 0
    OAUTH2_PROXY_COOKIE_EXPIRE: 1h
    
    # SSL verification - disable for self-signed/internal certs
    # OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY: "true"

  labels:
    # Enable routing
    traefik.enable: true

    # Certificate resolver
    traefik.http.routers.oauth2-proxy.tls.certresolver: le

    # Oauth2 Proxy router
    traefik.http.routers.oauth2-proxy.service: oauth2-proxy
    traefik.http.routers.oauth2-proxy.rule: "Host(`${OAUTH2_PROXY_DOMAIN}`) || PathPrefix(`/oauth2/`)"
    traefik.http.routers.oauth2-proxy.priority: 100
    traefik.http.routers.oauth2-proxy.entrypoints: websecure
    traefik.http.routers.oauth2-proxy.tls: true
    traefik.http.services.oauth2-proxy.loadbalancer.server.port: 4180

    # OAuth2‑Proxy forward auth middleware
    traefik.http.middlewares.oauth-auth.forwardauth.address: "http://oauth2-proxy:4180/oauth2/auth"
    traefik.http.middlewares.oauth-auth.forwardauth.trustForwardHeader: true
    traefik.http.middlewares.oauth-auth.forwardauth.authRequestHeaders: Cookie,Authorization
    traefik.http.middlewares.oauth-auth.forwardauth.authResponseHeaders: >-
      X-Auth-Request-User,
      X-Auth-Request-Email,
      X-Auth-Request-Preferred-Username,
      X-Auth-Request-Groups,
      X-Auth-Request-Access-Token

    # OAuth2‑Proxy error handling middleware
    traefik.http.middlewares.oauth-errors.errors.status: "401"
    traefik.http.middlewares.oauth-errors.errors.service: oauth2-proxy
    traefik.http.middlewares.oauth-errors.errors.query: "/oauth2/sign_in?rd={url}"
