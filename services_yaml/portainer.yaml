x-portainer-env: &portainer-env
  PORTAINER_DOMAIN: ${PORTAINER_DOMAIN}
  PORTAINER_BASIC_AUTH_USERS: ${PORTAINER_BASIC_AUTH_USERS}

x-portainer-service: &portainer-service
  <<: *service-base-with-proxy
  image: portainer/portainer-ce:2.35.0-alpine
  container_name: portainer
  security_opt:
   - no-new-privileges:true
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./services_data/portainer/internal/data:/data
  environment:
    <<: *portainer-env
  command: -H unix:///var/run/docker.sock
  labels:
    # Enable routing
    traefik.enable: true

    # Portainer router
    traefik.http.routers.portainer.service: portainer
    traefik.http.routers.portainer.rule: Host(`${PORTAINER_DOMAIN}`)
    traefik.http.routers.portainer.entrypoints: websecure
    # Redundant TLS labels removed as 'websecure' entrypoint handles it globally

    # Define the service port
    traefik.http.services.portainer.loadbalancer.server.port: 9000

    # Define Basic Auth middleware
    traefik.http.middlewares.portainer-auth.basicauth.users: ${PORTAINER_BASIC_AUTH_USERS}

    # Apply middlewares: Basic Auth and Security Headers
    traefik.http.routers.portainer.middlewares: portainer-auth@docker,security-headers@file
