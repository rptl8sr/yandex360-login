x-portainer-env: &portainer-env
  PORTAINER_DOMAIN: ${PORTAINER_DOMAIN:-portainer.docker.localhost}
  PORTAINER_BASIC_AUTH_USERS: ${PORTAINER_BASIC_AUTH_USERS}

x-portainer-service: &portainer-service
  <<: *service-base-with-proxy
  image: portainer/portainer-ce:2.33.5-alpine
  container_name: portainer

  security_opt:
    - no-new-privileges:true
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./services_data/portainer:/data
  environment:
    <<: *portainer-env
  command: -H unix:///var/run/docker.sock
  labels:
    # Enable routing
    traefik.enable: true

    # Certificate resolver
    traefik.http.routers.portainer.tls.certresolver: le

    # Portainer router
    traefik.http.routers.portainer.service: portainer
    traefik.http.routers.portainer.rule: Host(`${PORTAINER_DOMAIN}`)
    traefik.http.routers.portainer.entrypoints: websecure
    traefik.http.routers.portainer.tls: true
    traefik.http.services.portainer.loadbalancer.server.port: 9000

    # Middlewares: Add Basic Auth and the custom CSP
    traefik.http.routers.portainer.middlewares: portainer-auth@docker,portainer-csp@file

    # Basic Auth Middleware
    traefik.http.middlewares.portainer-auth.basicauth.users: ${PORTAINER_BASIC_AUTH_USERS}
